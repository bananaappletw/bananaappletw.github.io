(self.webpackChunkblog=self.webpackChunkblog||[]).push([[2396],{1504:(e,t,a)=>{"use strict";a.d(t,{Z:()=>r});var o=a(67294),n=a(65231);n.Z.initialize({startOnLoad:!0});const r=e=>{let{chart:t}=e;return(0,o.useEffect)((()=>{n.Z.contentLoaded()}),[]),o.createElement("div",{className:"mermaid"},t)}},42575:(e,t,a)=>{"use strict";a.r(t),a.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>m,frontMatter:()=>i,metadata:()=>l,toc:()=>u});var o=a(87462),n=(a(67294),a(3905)),r=a(1504);const i={title:"AWS resource hierarchy",tags:["aws"],date:new Date("2021-07-03T00:00:00.000Z")},s=void 0,l={permalink:"/blog/aws-resource-hierarchy",editUrl:"https://github.com/bananaappletw/blog/edit/master/blog/aws-resource-hierarchy.md",source:"@site/blog/aws-resource-hierarchy.md",title:"AWS resource hierarchy",description:"Overview",date:"2021-07-03T00:00:00.000Z",formattedDate:"July 3, 2021",tags:[{label:"aws",permalink:"/blog/tags/aws"}],readingTime:2.08,hasTruncateMarker:!1,authors:[],frontMatter:{title:"AWS resource hierarchy",tags:["aws"],date:"2021-07-03T00:00:00.000Z"},prevItem:{title:"KVM GPU passthrough Ubuntu 20.04",permalink:"/blog/kvm-gpu-passthrough-ubuntu-20-04"}},c={authorsImageUrls:[]},u=[{value:"Overview",id:"overview",level:2},{value:"Organization",id:"organization",level:2},{value:"Terraform",id:"terraform",level:2},{value:"SSO",id:"sso",level:2},{value:"Google apps SSO",id:"google-apps-sso",level:3},{value:"AWS SSO",id:"aws-sso",level:3}],p={toc:u};function m(e){let{components:t,...a}=e;return(0,n.kt)("wrapper",(0,o.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h2",{id:"overview"},"Overview"),(0,n.kt)("p",null,"Scenario:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"A company size of ",(0,n.kt)("inlineCode",{parentName:"li"},"200")," people seperated into ",(0,n.kt)("inlineCode",{parentName:"li"},"10")," teams."),(0,n.kt)("li",{parentName:"ul"},"Administer can have the company-wide policy to limit AWS account."),(0,n.kt)("li",{parentName:"ul"},"Easy way to switch user to the other team."),(0,n.kt)("li",{parentName:"ul"},"Single login page for user to login"),(0,n.kt)("li",{parentName:"ul"},"Each team wants its own access to its resources."),(0,n.kt)("li",{parentName:"ul"},"Also, different environment for specific purpose."),(0,n.kt)("li",{parentName:"ul"},"Sometimes, they need temporarily cooperation between teams."),(0,n.kt)("li",{parentName:"ul"},"For auditing, bills should be seperated by each team.")),(0,n.kt)("p",null,"Solution:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://aws.amazon.com/tw/organizations/"},"AWS Organization")," to have hiearchy architecture."),(0,n.kt)("li",{parentName:"ul"},"Move AWS Accounts into different ",(0,n.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_ous.html"},"Organizational Unit"),"."),(0,n.kt)("li",{parentName:"ul"},"Attach ",(0,n.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps.html"},"Service Control Policies")," to OU to limit AWS accounts."),(0,n.kt)("li",{parentName:"ul"},"Using seperated account for different enviroment, producion, staging...... .")),(0,n.kt)("h2",{id:"organization"},"Organization"),(0,n.kt)(r.Z,{chart:"\n\tgraph LR\n\t\tR[Organization root] --\x3e C[Company OU]\n\t\tC[Company OU] --\x3e A1[Team A production AWS account]\n\t\tC[Company OU] --\x3e A2[Team A staging AWS account]\n\t\tC[Company OU] --\x3e B1[Team B production AWS account]\n\t\tC[Company OU] --\x3e B2[Team B staging AWS account]\n\t\tR[Organization root] --\x3e P[playground AWS account]\n",mdxType:"Mermaid"}),(0,n.kt)("p",null,"Company OU will whitelist AWS resource and region.\nPlayground account has no limitation on AWS resource.\nPeriodically clean resource of playground account."),(0,n.kt)("admonition",{type:"info"},(0,n.kt)("p",{parentName:"admonition"},(0,n.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/cost-alloc-tags.html"},"AWS Tag")," is another solution to have more detail bill within AWS account.")),(0,n.kt)("h2",{id:"terraform"},"Terraform"),(0,n.kt)("p",null,"Create ",(0,n.kt)("inlineCode",{parentName:"p"},"terraform")," IAM access key and attach AdministratorAccess policy as Terraform repo's credential."),(0,n.kt)(r.Z,{chart:"\n\tgraph LR;\n\t\tA[A AWS account] --\x3e AT[A Terraform repo];\n\t\tAT[A Terraform repo] --\x3e A[A AWS account];\n\t\tB[B AWS account] --\x3e BT[B Terraform repo];\n\t\tBT[B Terraform repo] --\x3e B[B AWS account];\n",mdxType:"Mermaid"}),(0,n.kt)("h2",{id:"sso"},"SSO"),(0,n.kt)("admonition",{type:"caution"},(0,n.kt)("p",{parentName:"admonition"},"Recommended using SSO to manage AWS Accounts, otherwise you will have to manage your account from different place.")),(0,n.kt)("h3",{id:"google-apps-sso"},"Google apps SSO"),(0,n.kt)("admonition",{type:"warning"},(0,n.kt)("p",{parentName:"admonition"},"You have to have GSuite super administrator access.")),(0,n.kt)("p",null,"Follow the ",(0,n.kt)("a",{parentName:"p",href:"https://aws.amazon.com/blogs/security/how-to-set-up-federated-single-sign-on-to-aws-using-google-apps/"},"How to Set Up Federated Single Sign-On to AWS Using Google Apps")," instruction"),(0,n.kt)("p",null,"Then, you will find out it's one-to-one mapping between Google account and IAM role."),(0,n.kt)("p",null,"We want mapping of Google group and IAM role."),(0,n.kt)("p",null,"Refer repo ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/1Strategy/sso-to-aws-using-gsuite"},"https://github.com/1Strategy/sso-to-aws-using-gsuite")),(0,n.kt)("p",null,"By using GSuite Admin API"),(0,n.kt)("p",null,"Iterate the Google group, for each Google account, map to corresponding IAM role"),(0,n.kt)("h3",{id:"aws-sso"},"AWS SSO"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://aws.amazon.com/tw/single-sign-on/"},"https://aws.amazon.com/tw/single-sign-on/")),(0,n.kt)(r.Z,{chart:"\n\tgraph LR;\n\t\tA[A AWS account admin group] --\x3e AA[Administer role of A account];\n\t\tA[A AWS account readonly group] --\x3e AR[readonly role of account];\n\t\tB[B AWS account admin group] --\x3e BA[Administer role of A account];\n\t\tB[B AWS account readonly group] --\x3e BR[readonly role of account];\n",mdxType:"Mermaid"}),(0,n.kt)("p",null,"Assign user to group to have access to account."),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://aws.amazon.com/blogs/security/aws-single-sign-on-now-enables-command-line-interface-access-for-aws-accounts-using-corporate-credentials/"},"Neat short-term credentials for command line interface")))}m.isMDXComponent=!0},11748:(e,t,a)=>{var o={"./locale":89234,"./locale.js":89234};function n(e){var t=r(e);return a(t)}function r(e){if(!a.o(o,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return o[e]}n.keys=function(){return Object.keys(o)},n.resolve=r,e.exports=n,n.id=11748}}]);