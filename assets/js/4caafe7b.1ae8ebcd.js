(self.webpackChunkblog=self.webpackChunkblog||[]).push([[2146],{1504:(e,n,t)=>{"use strict";t.d(n,{Z:()=>a});var i=t(67294),o=t(65231);o.Z.initialize({startOnLoad:!0});const a=e=>{let{chart:n}=e;return(0,i.useEffect)((()=>{o.Z.contentLoaded()}),[]),i.createElement("div",{className:"mermaid"},n)}},21827:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>m,frontMatter:()=>r,metadata:()=>u,toc:()=>p});var i=t(87462),o=(t(67294),t(3905)),a=t(1504);const r={title:"KVM GPU passthrough Ubuntu 20.04",tags:["kvm","cloud-init","vfio","GPU"],date:new Date("2021-07-05T00:00:00.000Z")},l=void 0,u={permalink:"/blog/kvm-gpu-passthrough-ubuntu-20-04",editUrl:"https://github.com/bananaappletw/blog/edit/master/blog/kvm-gpu-passthrough-ubuntu-20-04.md",source:"@site/blog/kvm-gpu-passthrough-ubuntu-20-04.md",title:"KVM GPU passthrough Ubuntu 20.04",description:"Environment",date:"2021-07-05T00:00:00.000Z",formattedDate:"July 5, 2021",tags:[{label:"kvm",permalink:"/blog/tags/kvm"},{label:"cloud-init",permalink:"/blog/tags/cloud-init"},{label:"vfio",permalink:"/blog/tags/vfio"},{label:"GPU",permalink:"/blog/tags/gpu"}],readingTime:3.13,hasTruncateMarker:!1,authors:[],frontMatter:{title:"KVM GPU passthrough Ubuntu 20.04",tags:["kvm","cloud-init","vfio","GPU"],date:"2021-07-05T00:00:00.000Z"},prevItem:{title:"GCP resource hierarchy",permalink:"/blog/gcp-resource-hierarchy"},nextItem:{title:"AWS resource hierarchy",permalink:"/blog/aws-resource-hierarchy"}},d={authorsImageUrls:[]},p=[{value:"Environment",id:"environment",level:2},{value:"Enable IOMMU",id:"enable-iommu",level:2},{value:"Configure GRUB",id:"configure-grub",level:3},{value:"Update GRUB",id:"update-grub",level:3},{value:"Reboot",id:"reboot",level:3},{value:"Verify IOMMU is enabled",id:"verify-iommu-is-enabled",level:3},{value:"Enable IOMMU group",id:"enable-iommu-group",level:2},{value:"Check IOMMU group is enabled",id:"check-iommu-group-is-enabled",level:3},{value:"Edit BIOS setting is not enabled",id:"edit-bios-setting-is-not-enabled",level:3},{value:"VT-d",id:"vt-d",level:4},{value:"Isolation of the guest GPU",id:"isolation-of-the-guest-gpu",level:2},{value:"Using vfio-pci to manage PCI device",id:"using-vfio-pci-to-manage-pci-device",level:2},{value:"Find out vendor ID and device ID",id:"find-out-vendor-id-and-device-id",level:3},{value:"Configure GRUB",id:"configure-grub-1",level:3},{value:"Update GRUB",id:"update-grub-1",level:3},{value:"Reboot",id:"reboot-1",level:3},{value:"Verify PCI device is managed by vfio-pci",id:"verify-pci-device-is-managed-by-vfio-pci",level:3},{value:"Test GPU passthrough on kvm instance",id:"test-gpu-passthrough-on-kvm-instance",level:2},{value:"Fresh install",id:"fresh-install",level:3},{value:"Modify existing instance",id:"modify-existing-instance",level:3},{value:"Check GPU is working in guest",id:"check-gpu-is-working-in-guest",level:2},{value:"Reference",id:"reference",level:2}],s={toc:p};function m(e){let{components:n,...t}=e;return(0,o.kt)("wrapper",(0,i.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"environment"},"Environment"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Host: Ubuntu 20.04"),(0,o.kt)("li",{parentName:"ul"},"Guest: Ubuntu 20.04"),(0,o.kt)("li",{parentName:"ul"},"GPU: NVIDIA\xae GeForce\xae RTX 2080 Ti")),(0,o.kt)("h2",{id:"enable-iommu"},"Enable IOMMU"),(0,o.kt)("h3",{id:"configure-grub"},"Configure GRUB"),(0,o.kt)("p",null,"Edit ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/default/grub")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-grub"},'# Intel CPU\nGRUB_CMDLINE_LINUX_DEFAULT="intel_iommu=on"\n# AMD CPU\nGRUB_CMDLINE_LINUX_DEFAULT="amd_iommu=on iommu=pt kvm_amd.npt=1 kvm_amd.avic=1"\n')),(0,o.kt)("h3",{id:"update-grub"},"Update GRUB"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"sudo update-grub")),(0,o.kt)("h3",{id:"reboot"},"Reboot"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"sudo shutdown -r now")),(0,o.kt)("h3",{id:"verify-iommu-is-enabled"},"Verify IOMMU is enabled"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"dmesg | grep IOMMU")),(0,o.kt)("p",null,"Output:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"IOMMU enabled\n")),(0,o.kt)("h2",{id:"enable-iommu-group"},"Enable IOMMU group"),(0,o.kt)("h3",{id:"check-iommu-group-is-enabled"},"Check IOMMU group is enabled"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"for a in /sys/kernel/iommu_groups/*; do find $a -type l; done | sort --version-sort")),(0,o.kt)("p",null,"output:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"/sys/kernel/iommu_groups/0/devices/0000:00:00.0\n/sys/kernel/iommu_groups/1/devices/0000:00:04.0\n/sys/kernel/iommu_groups/2/devices/0000:00:04.1\n/sys/kernel/iommu_groups/3/devices/0000:00:04.2\n/sys/kernel/iommu_groups/4/devices/0000:00:04.3\n")),(0,o.kt)("h3",{id:"edit-bios-setting-is-not-enabled"},"Edit BIOS setting is not enabled"),(0,o.kt)("p",null,"If output is not expected, configure BIOS setting"),(0,o.kt)("h4",{id:"vt-d"},"VT-d"),(0,o.kt)("p",null,"(Asus)"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Advanced => System Agent Configuration => Intel VT for Directed I/O (VT-d)")),(0,o.kt)("p",null,"(Supermicro)"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Advanced => CPU Configuration => Intel Virtualization Technology => ","[enable]")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Advanced => Chipset Configuration => North Bridge => IIO Configuration => Intel VT fot Directed I/O (VT-d) => ","[enable]")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("a",{parentName:"p",href:"https://superuser.com/questions/1112238/intel-iommu-on-but-no-iommu-groups"},"https://superuser.com/questions/1112238/intel-iommu-on-but-no-iommu-groups")))),(0,o.kt)("h2",{id:"isolation-of-the-guest-gpu"},"Isolation of the guest GPU"),(0,o.kt)(a.Z,{chart:"\ngraph LR\n    subgraph C [guest]\n    C1[PCI device]\n    end\n    subgraph B [hypervisor]\n    B1[VFIO] --\x3e C1[PCI device]\n    end\n    subgraph A [Host]\n    A1[PCI device] --\x3e B1[VFIO]\n    end\n",mdxType:"Mermaid"}),(0,o.kt)("h2",{id:"using-vfio-pci-to-manage-pci-device"},"Using vfio-pci to manage PCI device"),(0,o.kt)("h3",{id:"find-out-vendor-id-and-device-id"},"Find out vendor ID and device ID"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"lspci -nn | grep -i NVIDIA")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"01:00.0 VGA compatible controller [0300]: NVIDIA Corporation TU102 [GeForce RTX 2080 Ti] [10de:1e04] (rev a1)\n01:00.1 Audio device [0403]: NVIDIA Corporation TU102 High Definition Audio Controller [10de:10f7] (rev a1)\n01:00.2 USB controller [0c03]: NVIDIA Corporation TU102 USB 3.1 Host Controller [10de:1ad6] (rev a1)\n01:00.3 Serial bus controller [0c80]: NVIDIA Corporation TU102 USB Type-C UCSI Controller [10de:1ad7] (rev a1)\n")),(0,o.kt)("p",null,"GeForce RTX 2080 Ti VGA compatible controller:\nPCI ID:",(0,o.kt)("inlineCode",{parentName:"p"},"01:00.0"),"\nvendor ID: ",(0,o.kt)("inlineCode",{parentName:"p"},"10de"),"\ndevice ID: ",(0,o.kt)("inlineCode",{parentName:"p"},"1e04")),(0,o.kt)("h3",{id:"configure-grub-1"},"Configure GRUB"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"/etc/default/grub")),(0,o.kt)("p",null,"Apply all the related devices"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'GRUB_CMDLINE_LINUX_DEFAULT="intel_iommu=on vfio-pci.ids=10de:1e04,10de:10f7,10de:1ad6,10de:1ad7"\n')),(0,o.kt)("h3",{id:"update-grub-1"},"Update GRUB"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"sudo update-grub")),(0,o.kt)("h3",{id:"reboot-1"},"Reboot"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"sudo reboot")),(0,o.kt)("h3",{id:"verify-pci-device-is-managed-by-vfio-pci"},"Verify PCI device is managed by vfio-pci"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"lspci -nnv")),(0,o.kt)("p",null,"Find the line ",(0,o.kt)("inlineCode",{parentName:"p"},"Kernel driver in use")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"0b:00.0 VGA compatible controller [0300]: NVIDIA Corporation TU102 [GeForce RTX 2080 Ti] [10de:1e04] (rev a1) (prog-if 00 [VGA controller])\n...\nKernel driver in use: vfio-pci\n")),(0,o.kt)("h2",{id:"test-gpu-passthrough-on-kvm-instance"},"Test GPU passthrough on kvm instance"),(0,o.kt)("h3",{id:"fresh-install"},"Fresh install"),(0,o.kt)("p",null,"Run ",(0,o.kt)("inlineCode",{parentName:"p"},"virt-install")," with ",(0,o.kt)("inlineCode",{parentName:"p"},"--host-device [device_id]")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"--features kvm_hidden=on")," parameters"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"virt-install ... \\\n--host-device 01:00.0 \\\n--features kvm_hidden=on \\\n")),(0,o.kt)("h3",{id:"modify-existing-instance"},"Modify existing instance"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"virsh edit [domain]")),(0,o.kt)("p",null,"Add PCI mapping ",(0,o.kt)("inlineCode",{parentName:"p"},"hostdev")," block"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"0000:01:00.0")," within the host will be mapped to ",(0,o.kt)("inlineCode",{parentName:"p"},"0000:04:00.0")," within guest"),(0,o.kt)("admonition",{type:"warning"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"bus")," number should less than virtio's"),(0,o.kt)("p",{parentName:"admonition"},"Increase virtio's bus number to spare small number for new added entry")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"<devices>\n  ...\n    <hostdev mode='subsystem' type='pci' managed='yes'>\n      <source>\n        <address domain='0x0000' bus='0x01' slot='0x00'function='0x0'/>\n      </source>\n      <address type='pci' domain='0x0000' bus='0x04'slot='0x00' function='0x0'/>\n    </hostdev>\n    <memballoon model='virtio'>\n      <address type='pci' domain='0x0000' bus='0x05'slot='0x00' function='0x0'/>\n    </memballoon>\n    <rng model='virtio'>\n      <backend model='random'>/dev/urandom</backend>\n      <address type='pci' domain='0x0000' bus='0x06'slot='0x00' function='0x0'/>\n    </rng>\n</devices>\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"kvm hidden")," within ",(0,o.kt)("inlineCode",{parentName:"p"},"features")," block"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"<features>\n...\n  <kvm>\n    <hidden state='on'/>\n  </kvm>\n</features>\n")),(0,o.kt)("h2",{id:"check-gpu-is-working-in-guest"},"Check GPU is working in guest"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"lspci")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"04:00.0 VGA compatible controller: NVIDIA Corporation TU102[GeForce RTX 2080 Ti] (rev a1)\n")),(0,o.kt)("p",null,"Install NVIDIA driver"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"sudo apt update\nsudo apt install nvidia-driver-460\nsudo reboot\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"nvidia-smi")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Wed Mar 10 08:19:43 2021\n+---------------------------------------------------------------------------+\n| NVIDIA-SMI 460.39       Driver Version: 460.39       CUDVersion: 11.2     |\n|-------------------------------+--------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage GPU-Util  Compute M. |\n|                               |                    |               MIG M. |\n|===============================+====================+======================|\n|   0  GeForce RTX 208...  Off  | 00000000:04:00.0 Of|                  N/A |\n| 15%   44C    P0     1W / 250W |      0MiB / 11019Mi|      0%      Default |\n|                               |                    |                  N/A |\n+-------------------------------+--------------------+----------------------+\n+---------------------------------------------------------------------------+\nProcesses:                                                                |\n|  GPU   GI   CI        PID   Type   Procesname                  GPU Memory |\n|        ID ID                                                 Usage      |\n===========================================================================|\n|  No running processefound                                                 |\n+---------------------------------------------------------------------------+\n")),(0,o.kt)("h2",{id:"reference"},"Reference"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://mathiashueber.com/pci-passthrough-ubuntu-2004-virtual-machine/"},"https://mathiashueber.com/pci-passthrough-ubuntu-2004-virtual-machine/"))))}m.isMDXComponent=!0},11748:(e,n,t)=>{var i={"./locale":89234,"./locale.js":89234};function o(e){var n=a(e);return t(n)}function a(e){if(!t.o(i,e)){var n=new Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}return i[e]}o.keys=function(){return Object.keys(i)},o.resolve=a,e.exports=o,o.id=11748}}]);